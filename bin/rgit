#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "rgit"
require "main"

Main {
  mode 'init' do
    argument 'path'
    def run()
      if params["path"].given?
        path = params['path'].value
        Rgit::Repo.create(path)
        puts "Created repository at #{path}"
      end
    end
  end

  mode 'cat-file' do
    argument 'type'
    argument 'object'
    def run()
      repo = Rgit::Repo.find
      object = Rgit::object_read(repo, Rgit::object_find(repo, params["object"].value, type=params["type"].value))
      $stdout.write(object.serialize)
    end
  end

  mode 'hash-object' do
    option('write', 'w')
    option('type', 't') {
      required
      argument_required
    }
    argument 'file'
    def run()
      repo = params["write"].given? ? Rgit::Repo.find : nil
      data = File.read(params["file"].value)
      type = params["type"].value
      object = Rgit::object_create(type, data, repo)
      raise "Unknown type #{type}!" if object.nil?
      puts Rgit::object_write(object, update_repo=false)
    end
  end

  mode 'ls-tree' do
    argument 'object'
    def run
      repo = Rgit::Repo.find
      object = Rgit::object_read(repo, Rgit::object_find(repo, params["object"].value, type="tree"))
      object.items.each do |item|
        mode = '0' * (6 - item.mode.length) + item.mode
        item_object = Rgit::object_read(repo, item.sha)
        puts "#{mode} #{item_object.type} #{item.sha}\t#{item.path}"
      end
    end
  end

  mode 'log' do
    argument('commit') {
      default 'HEAD'
    }
    def run
      repo = Rgit::Repo.find

      def visit_commit(repo, sha, seen)
        return if seen.key?(sha)
        seen[sha] = true

        commit = Rgit::object_read(repo, sha)
        raise "#{sha} is not a commit, but instead an instance of #{commit.class}!" unless commit.class == Rgit::Commit

        # Display commit.
        puts "commit #{sha}"
        puts "author: #{commit.data["author"]}"
        puts
        puts "\t#{commit.message}"
        puts

        # Base case: the initial commit.
        return if commit.parents.nil?

        # Parents
        commit.parents.each do |p|
          visit_commit(repo, p, seen)
        end
      end

      visit_commit(repo, Rgit::object_find(repo, params["commit"].value), {})
    end
  end

  mode 'version' do
    def run()
      puts "Rgit version #{Rgit::VERSION}"
    end
  end
}